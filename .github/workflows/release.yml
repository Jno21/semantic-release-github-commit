name: Release
"on":
  push:
    branches:
      - main
      - next
      - beta
      - "*.x"

permissions:
  contents: read # for checkout
  id-token: write # to enable use of OIDC for npm provenance

jobs:
  release:
    name: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v2
        id: app_token
        with:
          app-id: ${{ vars.SEMANTIC_RELEASE_GITHUB_COMMIT_APP_KEY }}
          private-key: ${{ secrets.SEMANTIC_RELEASE_GITHUB_COMMIT_PRIVATE_KEY }}
          permission-contents: write # to be able to publish a GitHub release
          permission-issues: write # to be able to comment on released issues
          permission-pull-requests: write # to be able to comment on released pull requests

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          cache: npm
          node-version: lts/*

      - run: npm clean-install

      - name: Build plugin
        run: npm run build

      - run: npm install --global corepack@latest

      - run: corepack npm audit signatures

      - run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ steps.app_token.outputs.token }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
